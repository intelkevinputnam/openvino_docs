
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Batch, Shape and Layout {#ovms_docs_shape_batch_layout} &#8212; OpenVINO™  documentation</title>
    
    
  <link href="../../../../_static/css/theme.css" rel="stylesheet">
  <link href="../../../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/css/blank.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/doxyrest-pygments.css" />
    
  <link rel="preload" as="script" href="../../../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <link href="../../../../_static/css/media/favicon.ico" rel="shortcut icon">
    <link rel="stylesheet" href="../../../../_static/css/openvino_sphinx_theme.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/css/button.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/css/input.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/css/textfield.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/css/tabs.css" type="text/css" />
    <script src="../../../../_static/js/openvino_sphinx_theme.js"></script>
    <link rel="stylesheet" href="../../../../_static/css/viewer.min.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/css/custom.css" type="text/css" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/0.5.7/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-barchart-background@1.3.0/build/Plugin.Barchart.Background.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-deferred@1"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.1/papaparse.min.js"></script>
    <script src="../../../../_static/js/viewer.min.js"></script>
    <script src="/assets/versions_raw.js"></script>

    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/tabs.js"></script>
    <script src="../../../../_static/clipboard.min.js"></script>
    <script src="../../../../_static/copybutton.js"></script>
    <script src="../../../../_static/js/custom.js"></script>
    <script src="../../../../_static/js/graphs.js"></script>
    <script src="../../../../_static/js/graphs_ov_tf.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../../_static/togglebutton.js"></script>
    <script src="../../../../_static/target-highlight.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <link rel="canonical" href="https://docs.openvino.ai/latest/pages/documentation/ecosystem/model-server/shape_batch_size_and_layout.html" />
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
      <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../../../../index.html">
  <img src="../../../../_static/logo.svg" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../get-started-guide.html">
  Get Started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../documentation.html">
  Documentation
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../../tutorials.html">
  Tutorials
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../../api/api_reference.html">
  API Reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../../model_zoo.html">
  Model Zoo
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../resources.html">
  Resources
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../../languages/zh_CN/index.html">
  简体中文
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/openvinotoolkit/openvino" rel="noopener" target="_blank" title="GitHub">
            <span><i class="sst-github"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
</ul>
      </div>
      
      <div class="navbar-end-item">
        
<div class="dropdown sst-dropdown sst-dropdown-navbar">
  <button class="btn sst-btn dropdown-toggle" type="button" id="version-selector" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button>
  <div class="dropdown-menu" aria-labelledby="version-selector">
  </div>
</div>
      </div>
      
      <div class="navbar-end-item">
        

<div class="dropdown sst-dropdown sst-dropdown-navbar">
  <button class="btn sst-btn dropdown-toggle" type="button" id="language-selector" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">English</button>
  <div class="dropdown-menu" aria-labelledby="language-selector">
    
      
        <a class="dropdown-item font-weight-bold" href="openvino_docs/index.html">English</a>
      
    
      
        <a  class="dropdown-item" href="openvino_docs/languages/zh_CN/index.html">简体中文 (Simplified Chinese)</a>
      
    
  </div>
</div>

      </div>
      
    </div>
  </div>
</div>
        <div id="collapse-nav-wrapper" class="container-xl">
          <button id="collapse-nav" class="button bttn-prm button-size-m" type="button" data-toggle="collapse" data-target="#nav-tree" aria-expanded="false" aria-controls="nav-tree">
            Documentation navigation <i class="fas fa-chevron-down"></i>
          </button>
        </div>
      </nav>
      <div class="transition-banner container-fluid alert alert-info alert-dismissible fade show" role="alert">
        <p>OpenVINO 2022.1 introduces a new version of OpenVINO API (API 2.0). For more information on the changes and transition steps, see the <a href="https://docs.openvino.ai/latest/openvino_2_0_transition_guide.html">transition guide</a></p>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
    </div>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar" id="nav-tree"><form class="searchForm bd-search d-flex align-items-center" action="../../../../search.html" method="get">
    <i class="icon fas fa-search"></i>
    <input type="search" class="form-control" name="query" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#batch-processing-in-openvino-model-server">
   Batch Processing in OpenVINO™ Model Server
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-reshaping-in-openvino-model-server">
   Model reshaping in OpenVINO™ Model Server
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#changing-model-input-output-layout">
   Changing model input/output layout
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#important">
     Important
    </a>
   </li>
  </ul>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                <div class="tocsection download-docs">
  <div class="dropdown sst-dropdown">
    <button class="button bttn-prm button-size-m" data-display="static" type="button" id="download-options"
      data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      Download Docs
    </button>
    <div class="dropdown-menu" aria-labelledby="download-options">
      <a class="dropdown-item" href="#" onclick="window.print()">.pdf</a>
      <a id="download-zip-btn" class="dropdown-item" href="#">.zip</a>
    </div>
  </div>
</div>
              </div>
              
            
          </div>
          

          
          
              
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">

<div class="tocsection editthispage">
    <a href="None">
        <i class="fas fa-pencil-alt"></i> Edit this page
    </a>
</div>

            
                <div>
                  
  <section id="batch-shape-and-layout-ovms-docs-shape-batch-layout">
<h1>Batch, Shape and Layout {#ovms_docs_shape_batch_layout}<a class="headerlink" href="#batch-shape-and-layout-ovms-docs-shape-batch-layout" title="Permalink to this headline">¶</a></h1>
<section id="batch-processing-in-openvino-model-server">
<h2>Batch Processing in OpenVINO™ Model Server<a class="headerlink" href="#batch-processing-in-openvino-model-server" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">batch_size</span></code> parameter is optional. By default, the batch size is derived from the model. It is set by the model optimizer tool.</p></li>
<li><p>When that parameter is set to a numerical value, it is changing the model batch size at the service start.
It accepts also a value <code class="docutils literal notranslate"><span class="pre">auto</span></code> - this command makes the served model set the batch size automatically based on the incoming data at run time.</p></li>
<li><p>Each time the input data change the batch size, the model is reloaded. It might have an extra response delay for the first request.
This feature is useful for sequential inference requests of the same batch size.</p></li>
</ul>
<p><em>Note:</em> In case of frequent batch size changes in predict requests, consider using <a class="reference internal" href="demultiplexing.html"><span class="doc std std-doc">demultiplexing feature</span></a> from <a class="reference internal" href="dag_scheduler.html"><span class="doc std std-doc">Directed Acyclic Graph Scheduler</span></a> which is more
performant in such situations because it is not adding an extra overhead with model reloading between requests like –batch_size auto setting. Examplary usage of this feature can be found in <a class="reference internal" href="dynamic_bs_demultiplexer.html"><span class="doc std std-doc">dynamic_batch_size</span></a> document.</p>
<ul class="simple">
<li><p>OpenVINO™ Model Server determines the batch size based on the size of the first dimension in the first input.
For example with the input shape (1, 3, 225, 225), the batch size is set to 1. With input shape (8, 3, 225, 225) the batch size is set to 8.</p></li>
</ul>
<p><em>Note:</em> Some models like object detection do not work correctly with batch size changed with the <code class="docutils literal notranslate"><span class="pre">batch_size</span></code> parameter. Typically those are the models,
whose output’s first dimension is not representing the batch size like on the input side.
Changing batch size in this models can be done with the network reshaping by setting <code class="docutils literal notranslate"><span class="pre">shape</span></code> parameter appropriately or specify batch position using <code class="docutils literal notranslate"><span class="pre">--layout</span></code> parameter (read below).</p>
</section>
<section id="model-reshaping-in-openvino-model-server">
<h2>Model reshaping in OpenVINO™ Model Server<a class="headerlink" href="#model-reshaping-in-openvino-model-server" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">shape</span></code> parameter is optional and it takes precedence over the batch_size parameter. When the shape is defined as an argument,
it ignores the batch_size value.</p></li>
<li><p>The shape argument can change the model enabled in the model server to fit the required parameters. It accepts 3 forms of the values:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;auto&quot;</span></code> phrase - model server will be reloading the model with the shape matching the input data matrix.</p></li>
<li><p>a tuple e.g. <code class="docutils literal notranslate"><span class="pre">&quot;(1,3,224,224)&quot;</span></code> - it defines the shape to be used for all incoming requests for models with a single input</p></li>
<li><p>JSON object e.g. <code class="docutils literal notranslate"><span class="pre">{&quot;input1&quot;:&quot;(1,3,224,224)&quot;,&quot;input2&quot;:&quot;(1,3,50,50)&quot;}</span></code> - it defines a shape of every included input in the model</p></li>
</ul>
</li>
</ul>
<p><em>Note:</em> Some models do not support the reshape operation. Learn more about supported model graph layers including all limitations
on <a class="reference external" href="https://docs.openvino.ai/2022.1/openvino_docs_IE_DG_ShapeInference.html">Shape Inference Document</a>.
In case the model can’t be reshaped, it will remain in the original parameters and all requests with incompatible input format
will get an error. The model server will also report such problems in the logs.</p>
</section>
<section id="changing-model-input-output-layout">
<h2>Changing model input/output layout<a class="headerlink" href="#changing-model-input-output-layout" title="Permalink to this headline">¶</a></h2>
<p>Starting from 2022.1, Model Optimizer by default preserves the layout of original model. If the model uses NHWC layout before conversion to IR format, it will be preserved after conversion. Model Optimizer can also be used to add transposition step to change the layout to desired one. Models which process image data are usually exported with NCHW or NHWC layout. Image transformation libraries like OpenCV or Pillow use NHWC layout. To minimize amount of overhead caused by transposition operation, it is suggested to export your model with NHWC layout.</p>
<p>In case you already have model with NCHW layout and are not willing to re-export it, OpenVINO™ Model Server allows changing input/output layout at runtime with <code class="docutils literal notranslate"><span class="pre">--layout</span></code> parameter via CLI or <code class="docutils literal notranslate"><span class="pre">config.json</span></code>. Please note that it modifies the model by adding transposition operations as pre-processing step.</p>
<p>Layout parameter is optional. By default layout is inherited from OpenVINO™ model. You can use this parameter to adjust models both in ONNX and Intermediate Representation format. In case no layout was specified during model export phase, the default layout OpenVINO™ Model Server sets is <code class="docutils literal notranslate"><span class="pre">N...</span></code>. It means that the only known dimensions is the first one - batch (<code class="docutils literal notranslate"><span class="pre">N</span></code>), and there is undefined amount of dimensions following the batch.</p>
<p>Layout change is supported for variety of combinations accepting following characters: <code class="docutils literal notranslate"><span class="pre">N</span></code>, <code class="docutils literal notranslate"><span class="pre">C</span></code>, <code class="docutils literal notranslate"><span class="pre">H</span></code>, <code class="docutils literal notranslate"><span class="pre">W</span></code>, <code class="docutils literal notranslate"><span class="pre">D</span></code>, <code class="docutils literal notranslate"><span class="pre">?</span></code>, <code class="docutils literal notranslate"><span class="pre">...</span></code>. Each dimension can appear only once. The exception is <code class="docutils literal notranslate"><span class="pre">?</span></code> which can appear multiple times meaning that there is unknown dimension on given position. <code class="docutils literal notranslate"><span class="pre">...</span></code> means that there is unknown number of dimensions in between given dimensions.</p>
<p>Examples:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">NHW</span></code> - means there are 3 dimensions: <em>batch</em>, <em>height</em> and <em>width</em>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">N??C</span></code> - means there are 4 dimensions: first being <em>batch</em>, 4th being the <em>channels</em> and 2 unknown dimensions on second and third position</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NC...W</span></code> - means there are undefined amount of dimensions: first being <em>batch</em>, second being the <em>channels</em> and the last dimension is <em>width</em>.</p></li>
</ul>
<p>You can specify 2 forms of values:</p>
<ul class="simple">
<li><p>string - e.g. <code class="docutils literal notranslate"><span class="pre">NCHW</span></code> (which expands to <code class="docutils literal notranslate"><span class="pre">NCHW:NCHW</span></code>) or <code class="docutils literal notranslate"><span class="pre">NHWC:NCHW</span></code>; both applicable only for models with single input tensor</p></li>
<li><p>JSON object - e.g. <code class="docutils literal notranslate"><span class="pre">{&quot;input1&quot;:&quot;NHWC:NCHW&quot;,</span> <span class="pre">&quot;input2&quot;:&quot;NHWC:NCHW&quot;,</span> <span class="pre">&quot;output1&quot;:&quot;CN:NC&quot;}</span></code>; allows to specify layout for multiple inputs and outputs by name.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">&lt;target_layout&gt;:&lt;source_layout&gt;</span></code> notation means:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;target_layout&gt;</span></code> request input data layout</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;source_layout&gt;</span></code> layout expected by model</p></li>
</ul>
<p>After the model layout is changed, the requests must match the new, (updated by transposition) shape matching <code class="docutils literal notranslate"><span class="pre">&lt;target_layout&gt;</span></code> parameter.</p>
<p>Example, given the parameter <code class="docutils literal notranslate"><span class="pre">--layout</span> <span class="pre">NHWC:NCHW</span></code>:</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p></p></th>
<th class="head"><p>Inherited from model</p></th>
<th class="head"><p>New expected metadata</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>shape</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">(1,</span> <span class="pre">3,</span> <span class="pre">224,</span> <span class="pre">224)</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">(1,</span> <span class="pre">224,</span> <span class="pre">224,</span> <span class="pre">3)</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>layout</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">N...</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">NHWC</span></code></p></td>
</tr>
</tbody>
</table>
<p>This is also possible to omit the colon (<code class="docutils literal notranslate"><span class="pre">:</span></code>) and pass single layout parameter: e.g. <code class="docutils literal notranslate"><span class="pre">--layout</span> <span class="pre">CN</span></code>. This does not add transposition step, but allows guiding Model Server to treat inputs as if batch size was on second position. This is significant when exported model has batch on arbitrary position and <code class="docutils literal notranslate"><span class="pre">--batch_size</span> <span class="pre">auto</span></code> is used, which makes the model reload with new batch size to match request batch dimension.</p>
<section id="important">
<h3>Important<a class="headerlink" href="#important" title="Permalink to this headline">¶</a></h3>
<p>Changing layout is not supported for models with input names the same as output names. <br>
For model included in DAG, layouts of subsequent nodes must match, similary to network shape and precision.</p>
<blockquote>
<div><p><strong>WARNING</strong>: Beginning with 2022.1 release, the <code class="docutils literal notranslate"><span class="pre">--layout</span></code> parameter has changed meaning and the setting is not back compatible. Previously to change from <code class="docutils literal notranslate"><span class="pre">NCHW</span></code> to <code class="docutils literal notranslate"><span class="pre">NHWC</span></code> it was required to pass <code class="docutils literal notranslate"><span class="pre">--layout</span> <span class="pre">NHWC</span></code>, now it is required to pass <code class="docutils literal notranslate"><span class="pre">--layout</span> <span class="pre">NHWC:NCHW</span></code>. The prior version does not add preprocessing step and just informs about incorrect layout of exported model.</p>
</div></blockquote>
</section>
</section>
</section>


                </div>
            
            
                <div class='prev-next-bottom'>
                  

                </div>
            
          </main>
          

      </div>
    </div>
  
  <script src="../../../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2021, Intel®.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.2.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>